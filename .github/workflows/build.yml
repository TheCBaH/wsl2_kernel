name: Build

on:
  push:
  pull_request:
  schedule:
    - cron: 0 1 * * MON
  workflow_dispatch:

jobs:
  git:
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@v2
      with:
        submodules: false
    - id: repo-key
      run: |
        echo "::set-output name=date::$(/bin/date -u "+%Y%m")"
    - uses: actions/cache@v2
      id: wsl2_repo
      with:
        path: wsl2-repo
        key: ${{ steps.repo-key.outputs.date }}
    - name: git
      if: steps.wsl2_repo.outputs.cache-hit != 'true'
      run: |
        set -x
        ./git-prepare.sh
        du -sh wsl2-repo
        df -h
    - name: checkout
      run: |
        set -x
        cp -rl wsl2-repo wsl2-repo.git
        git -c protocol.version=2 -C wsl2-repo.git remote fetch --depth 1 origin linux-msft-4.19.128:linux-msft-4.19.128
        git -C checkout linux-msft-4.19.128
  kernel:
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@v2
      with:
        submodules: true
    - name: kbuild.image
      run: |
        set -x
        image=$(make kbuild.image_print)
        IMAGE_ID=ghcr.io/${{ github.repository_owner }}/$GITHUB_REPOSITORY/$image
        IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
        old_id=''
        if docker pull $IMAGE_ID; then
          old_id=$(docker image inspect $IMAGE_ID --format "{{.ID}}")
        fi
        make kbuild.image DOCKER_BUILD_OPTS="--cache-from=$IMAGE_ID"
        new_id=$(docker image inspect $image --format "{{.ID}}")
        if [ "$old_id" != "$new_id" ]; then
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker tag $image $IMAGE_ID:latest
          docker push $IMAGE_ID:latest || true
          rm -rf ~/.docker
        fi
    - name: kbuild.ccache
      run: |
        set -x
        make kbuild.ccache-init
        make kbuild.ccache CPU_CORES=2
        du -sh .ccache
